{% extends 'base.html.twig' %}

{% block body %}

{% if selectedchild is null or selectedchild is empty  %}
  <div class="alert alert-danger alert-dismissible fade show" role="alert">
   <h4 class="alert-heading">Enfant non selectionné</h4>
   <p>Vous devez choisir un enfant dans le menu</p>
    <ul class="list-group list-group-horizontal mx-auto" style="width: 350px;">
      {% for child in children %}
      <li class="list-group-item list-group-item-danger list-group-item-action">
        <a class="nav-link" aria-current="page" href="{{ path('app_home_child', {id: child.id}) }}">{{child}} ({{ child.points }})</a>
      </li>
      {% endfor %}
    </ul>
  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
</div>
{% else %}
  {% if historics is empty %}
    <div class="alert alert-info text-center" role="alert">
      Aucun événement ce jour.
    </div>
  {% endif %}

  {% for date,histos in historics %}
    {% set total = 0 %}
    {% for h in histos %}
      {% set p = h.task ? h.task.points : (h.points ?? 0) %}
      {% set total = total + p %}
    {% endfor %}
    <ul class="list-group"> 
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <span>{{date}}</span>
        <span class="badge rounded-pill text-bg-secondary">Total: {% if total > 0 %}+{{ total }}{% else %}{{ total }}{% endif %}</span>
      </li>
      {% for historic in histos %}
        {# Déterminer le style selon la tâche ou l'ajustement manuel #}
        {% set item_style = 'list-group-item-light' %}
        {% if historic.task is not null %}
          {% set item_style = 'list-group-item-success' %}
          {% if historic.task.type == 1 %}
            {% set item_style = 'list-group-item-danger' %}
          {% endif %}
          {% if historic.task.type == 2 %}
            {% set item_style = 'list-group-item-warning' %}
          {% endif %}
        {% else %}
          {% if historic.points is defined and historic.points is not null %}
            {% if historic.points < 0 %}
              {% set item_style = 'list-group-item-danger' %}
            {% elseif historic.points > 0 %}
              {% set item_style = 'list-group-item-success' %}
            {% endif %}
          {% endif %}
        {% endif %}

        <li class="list-group-item  {{ item_style }}">
            <div class="container text-center">
              <div class="row">
                <div class="col text-start">
                 {{ historic.task ?? historic.description ?? 'Ajustement manuel' }}
                </div>
                <div class="col text-end">
                 {% set pts = historic.task ? historic.task.points : (historic.points ?? 0) %}
                 {% set badge = 'secondary' %}
                 {% if historic.task is not null %}
                   {% set badge = historic.task.type == 0 ? 'success' : (historic.task.type == 1 ? 'danger' : 'warning') %}
                 {% else %}
                   {% if pts > 0 %}{% set badge = 'success' %}{% elseif pts < 0 %}{% set badge = 'danger' %}{% else %}{% set badge = 'secondary' %}{% endif %}
                 {% endif %}

                 <span class="badge rounded-pill text-bg-{{ badge }}">{% if pts > 0 %}+{{ pts }}{% else %}{{ pts }}{% endif %}</span>
                 &nbsp; {{ historic.createdAt|date("d/m/Y H:i:s", "Europe/Paris") }}
                </div>
              </div>
            </div>
        </li>
        {% endfor %}
  </ul>
  <div class='clearfix'>&nbsp;</div>
{% endfor %}

{% endif %}

{# Sélecteur de date et pagination #}
{% if pagination is defined and pagination.totalPages > 1 %}
  {% set prevIndex = pagination.currentPage - 2 %}
  {% set nextIndex = pagination.currentPage %}
  {% set prevLabel = pagination.allDates[prevIndex] is defined ? pagination.allDates[prevIndex] : null %}
  {% set nextLabel = pagination.allDates[nextIndex] is defined ? pagination.allDates[nextIndex] : null %}
  {% set parts = pagination.currentDate ? pagination.currentDate|split('/') : [] %}
  {% set isoCurrent = parts|length == 3 ? parts[2] ~ '-' ~ parts[1] ~ '-' ~ parts[0] : '' %}
  <div id="historic-nav" class="mt-4" data-prev-url="{% if pagination.hasPrevious %}{{ path('app_home_historic', {page: pagination.previousPage}) }}{% endif %}" data-next-url="{% if pagination.hasNext %}{{ path('app_home_historic', {page: pagination.nextPage}) }}{% endif %}">
    {# Sélecteur de date rapide #}
    <div class="d-flex justify-content-center mb-3">
      <div class="input-group" style="max-width: 320px;">
        <span class="input-group-text">
          <i class="fa fa-calendar"></i>
        </span>
        <input type="date" id="date-picker" class="form-control" 
               value="{{ isoCurrent }}"
               onchange="goToDate(this.value)">
        <button class="btn btn-outline-secondary" type="button" onclick="goToDate(document.getElementById('date-picker').value)">
          Aller
        </button>
      </div>
    </div>

    {# Pagination élégante #}
    <div class="d-flex justify-content-center">
      <nav aria-label="Navigation de l'historique">
        <ul class="pagination pagination-sm">
          {# Bouton Précédent (chevron + date) #}
          {% if pagination.hasPrevious %}
            <li class="page-item">
              <a class="page-link d-flex align-items-center gap-1" href="{{ path('app_home_historic', {page: pagination.previousPage}) }}" aria-label="{{ prevLabel ?? 'Date précédente' }}">
                <i class="fa fa-chevron-left"></i>
                <span>{{ prevLabel }}</span>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">—</span>
            </li>
          {% endif %}

          {# Date actuelle #}
          <li class="page-item ">
            <span class="page-link fw-bold">
              {{ pagination.currentDate }}
            </span>
          </li>

          {# Bouton Suivant (date + chevron) #}
          {% if pagination.hasNext %}
            <li class="page-item">
              <a class="page-link d-flex align-items-center gap-1" href="{{ path('app_home_historic', {page: pagination.nextPage}) }}" aria-label="{{ nextLabel ?? 'Date suivante' }}">
                <span>{{ nextLabel }}</span>
                <i class="fa fa-chevron-right"></i>
              </a>
            </li>
          {% else %}
            <li class="page-item disabled">
              <span class="page-link">—</span>
            </li>
          {% endif %}
        </ul>
      </nav>
    </div>

    {# Indicateur de position #}
    <div class="text-center mt-2">
      <small class="text-muted">
        {{ pagination.currentPage }} sur {{ pagination.totalPages }} dates
      </small>
    </div>
  </div>

  {# Plus de Flatpickr; datepicker natif uniquement #}

  <script>
    function goToDate(dateString) {
      if (dateString) {
        const date = new Date(dateString);
        const formattedDate = date.toLocaleDateString('fr-FR');
        
        // Trouver l'index de la date dans la liste des dates disponibles
        const dates = {{ pagination.allDates|json_encode|raw }};
        const dateIndex = dates.indexOf(formattedDate);
        
        if (dateIndex !== -1) {
          const page = Math.floor(dateIndex / 1) + 1; // 1 date par page
          window.location.href = '{{ path('app_home_historic') }}?page=' + page;
        } else {
          alert('Aucun historique disponible pour cette date');
        }
      }
    }
  </script>
{% endif %}
{% endblock %}
